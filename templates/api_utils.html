{% extends "layout.html" %}

{% block title %}Replit Agent - API Utilities{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12 mb-4">
        <h2><i data-feather="globe" class="me-2"></i>API Utilities</h2>
        <p class="lead">Fetch data from external APIs, download files, and perform other API operations.</p>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i data-feather="server" class="me-2"></i>API Request</h5>
            </div>
            <div class="card-body">
                <form id="api-request-form">
                    <div class="mb-3">
                        <label for="api-url" class="form-label">URL</label>
                        <input type="text" class="form-control" id="api-url" placeholder="https://api.example.com/data">
                    </div>
                    <div class="mb-3">
                        <label for="request-method" class="form-label">Method</label>
                        <select class="form-select" id="request-method">
                            <option value="GET" selected>GET</option>
                            <option value="POST">POST</option>
                            <option value="PUT">PUT</option>
                            <option value="DELETE">DELETE</option>
                            <option value="PATCH">PATCH</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="request-headers" class="form-label">Headers (JSON)</label>
                        <textarea class="form-control" id="request-headers" rows="3" placeholder='{"Content-Type": "application/json", "Authorization": "Bearer YOUR_TOKEN"}'></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="request-params" class="form-label">Query Parameters (JSON)</label>
                        <textarea class="form-control" id="request-params" rows="2" placeholder='{"page": 1, "limit": 10}'></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="request-body" class="form-label">Request Body (JSON)</label>
                        <textarea class="form-control" id="request-body" rows="5" placeholder='{"name": "John Doe", "email": "john@example.com"}'></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="request-timeout" class="form-label">Timeout (seconds)</label>
                        <input type="number" class="form-control" id="request-timeout" value="30" min="1" max="300">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i data-feather="send" class="me-1"></i>Send Request
                    </button>
                </form>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i data-feather="download" class="me-2"></i>File Download</h5>
            </div>
            <div class="card-body">
                <form id="file-download-form">
                    <div class="mb-3">
                        <label for="download-url" class="form-label">URL</label>
                        <input type="text" class="form-control" id="download-url" placeholder="https://example.com/file.pdf">
                    </div>
                    <div class="mb-3">
                        <label for="download-destination" class="form-label">Destination Path</label>
                        <input type="text" class="form-control" id="download-destination" placeholder="downloads/file.pdf">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i data-feather="download" class="me-1"></i>Download File
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i data-feather="activity" class="me-2"></i>Response</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" id="copy-response-btn">
                            <i data-feather="copy" class="me-1"></i>Copy
                        </button>
                        <button class="btn btn-sm btn-outline-secondary ms-2" id="clear-response-btn">
                            <i data-feather="trash-2" class="me-1"></i>Clear
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="response-container" class="min-height-400">
                    <div class="text-center text-muted py-5">
                        <i data-feather="inbox" style="width: 48px; height: 48px;"></i>
                        <p class="mt-3">Send a request to see the response</p>
                    </div>
                </div>
            </div>
            <div class="card-footer d-none" id="response-metadata">
                <div class="row">
                    <div class="col-md-4">
                        <small class="text-muted">Status: <span id="response-status">-</span></small>
                    </div>
                    <div class="col-md-4 text-center">
                        <small class="text-muted">Time: <span id="response-time">-</span> ms</small>
                    </div>
                    <div class="col-md-4 text-end">
                        <small class="text-muted">Size: <span id="response-size">-</span></small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i data-feather="bookmark" class="me-2"></i>Saved Requests</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <button class="btn btn-sm btn-outline-primary" id="save-request-btn">
                        <i data-feather="save" class="me-1"></i>Save Current Request
                    </button>
                </div>
                <div id="saved-requests-container">
                    <div class="text-center text-muted">
                        <p>No saved requests</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i data-feather="tool" class="me-2"></i>API Tools</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-secondary" id="url-encode-btn">
                        <i data-feather="lock" class="me-1"></i>URL Encode/Decode
                    </button>
                    <button class="btn btn-outline-secondary" id="base64-btn">
                        <i data-feather="code" class="me-1"></i>Base64 Encode/Decode
                    </button>
                    <button class="btn btn-outline-secondary" id="json-formatter-btn">
                        <i data-feather="align-left" class="me-1"></i>JSON Formatter
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Save Request Modal -->
<div class="modal fade" id="save-request-modal" tabindex="-1" aria-labelledby="save-request-modal-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="save-request-modal-label">Save Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="save-request-form">
                    <div class="mb-3">
                        <label for="request-name" class="form-label">Request Name</label>
                        <input type="text" class="form-control" id="request-name" placeholder="Enter a name for this request">
                    </div>
                    <div class="mb-3">
                        <label for="request-description" class="form-label">Description (optional)</label>
                        <textarea class="form-control" id="request-description" rows="2" placeholder="Enter a brief description"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-request-submit">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- URL Encode/Decode Modal -->
<div class="modal fade" id="url-encode-modal" tabindex="-1" aria-labelledby="url-encode-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="url-encode-modal-label">URL Encode/Decode</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="url-input" class="form-label">Input</label>
                        <textarea class="form-control" id="url-input" rows="8" placeholder="Enter text to encode or decode"></textarea>
                    </div>
                    <div class="col-md-6">
                        <label for="url-output" class="form-label">Output</label>
                        <textarea class="form-control" id="url-output" rows="8" readonly></textarea>
                    </div>
                </div>
                <div class="d-flex justify-content-center">
                    <button class="btn btn-primary me-2" id="url-encode-action-btn">Encode</button>
                    <button class="btn btn-secondary me-2" id="url-decode-action-btn">Decode</button>
                    <button class="btn btn-outline-secondary" id="url-copy-output-btn">
                        <i data-feather="copy" class="me-1"></i>Copy Output
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Base64 Encode/Decode Modal -->
<div class="modal fade" id="base64-modal" tabindex="-1" aria-labelledby="base64-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="base64-modal-label">Base64 Encode/Decode</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="base64-input" class="form-label">Input</label>
                        <textarea class="form-control" id="base64-input" rows="8" placeholder="Enter text to encode or decode"></textarea>
                    </div>
                    <div class="col-md-6">
                        <label for="base64-output" class="form-label">Output</label>
                        <textarea class="form-control" id="base64-output" rows="8" readonly></textarea>
                    </div>
                </div>
                <div class="d-flex justify-content-center">
                    <button class="btn btn-primary me-2" id="base64-encode-action-btn">Encode</button>
                    <button class="btn btn-secondary me-2" id="base64-decode-action-btn">Decode</button>
                    <button class="btn btn-outline-secondary" id="base64-copy-output-btn">
                        <i data-feather="copy" class="me-1"></i>Copy Output
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- JSON Formatter Modal -->
<div class="modal fade" id="json-formatter-modal" tabindex="-1" aria-labelledby="json-formatter-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="json-formatter-modal-label">JSON Formatter</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="json-input" class="form-label">Input JSON</label>
                        <textarea class="form-control" id="json-input" rows="12" placeholder="Enter JSON to format"></textarea>
                    </div>
                    <div class="col-md-6">
                        <label for="json-output" class="form-label">Formatted JSON</label>
                        <textarea class="form-control" id="json-output" rows="12" readonly></textarea>
                    </div>
                </div>
                <div class="d-flex justify-content-center">
                    <button class="btn btn-primary me-2" id="json-format-action-btn">Format</button>
                    <button class="btn btn-secondary me-2" id="json-minify-action-btn">Minify</button>
                    <button class="btn btn-outline-secondary" id="json-copy-output-btn">
                        <i data-feather="copy" class="me-1"></i>Copy Output
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loading-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="loading-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mb-0" id="loading-message">Processing your request...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // API Request form elements
        const apiRequestForm = document.getElementById('api-request-form');
        const apiUrlInput = document.getElementById('api-url');
        const requestMethodSelect = document.getElementById('request-method');
        const requestHeadersInput = document.getElementById('request-headers');
        const requestParamsInput = document.getElementById('request-params');
        const requestBodyInput = document.getElementById('request-body');
        const requestTimeoutInput = document.getElementById('request-timeout');
        
        // File Download form elements
        const fileDownloadForm = document.getElementById('file-download-form');
        const downloadUrlInput = document.getElementById('download-url');
        const downloadDestinationInput = document.getElementById('download-destination');
        
        // Response elements
        const responseContainer = document.getElementById('response-container');
        const responseMetadata = document.getElementById('response-metadata');
        const responseStatus = document.getElementById('response-status');
        const responseTime = document.getElementById('response-time');
        const responseSize = document.getElementById('response-size');
        const copyResponseBtn = document.getElementById('copy-response-btn');
        const clearResponseBtn = document.getElementById('clear-response-btn');
        
        // Saved Requests elements
        const saveRequestBtn = document.getElementById('save-request-btn');
        const savedRequestsContainer = document.getElementById('saved-requests-container');
        
        // Tool buttons
        const urlEncodeBtn = document.getElementById('url-encode-btn');
        const base64Btn = document.getElementById('base64-btn');
        const jsonFormatterBtn = document.getElementById('json-formatter-btn');
        
        // Modals
        const saveRequestModal = new bootstrap.Modal(document.getElementById('save-request-modal'));
        const urlEncodeModal = new bootstrap.Modal(document.getElementById('url-encode-modal'));
        const base64Modal = new bootstrap.Modal(document.getElementById('base64-modal'));
        const jsonFormatterModal = new bootstrap.Modal(document.getElementById('json-formatter-modal'));
        const loadingModal = new bootstrap.Modal(document.getElementById('loading-modal'));
        
        // Save Request form elements
        const requestNameInput = document.getElementById('request-name');
        const requestDescriptionInput = document.getElementById('request-description');
        const saveRequestSubmit = document.getElementById('save-request-submit');
        
        // URL Encode/Decode elements
        const urlInput = document.getElementById('url-input');
        const urlOutput = document.getElementById('url-output');
        const urlEncodeActionBtn = document.getElementById('url-encode-action-btn');
        const urlDecodeActionBtn = document.getElementById('url-decode-action-btn');
        const urlCopyOutputBtn = document.getElementById('url-copy-output-btn');
        
        // Base64 Encode/Decode elements
        const base64Input = document.getElementById('base64-input');
        const base64Output = document.getElementById('base64-output');
        const base64EncodeActionBtn = document.getElementById('base64-encode-action-btn');
        const base64DecodeActionBtn = document.getElementById('base64-decode-action-btn');
        const base64CopyOutputBtn = document.getElementById('base64-copy-output-btn');
        
        // JSON Formatter elements
        const jsonInput = document.getElementById('json-input');
        const jsonOutput = document.getElementById('json-output');
        const jsonFormatActionBtn = document.getElementById('json-format-action-btn');
        const jsonMinifyActionBtn = document.getElementById('json-minify-action-btn');
        const jsonCopyOutputBtn = document.getElementById('json-copy-output-btn');
        
        // Loading modal element
        const loadingMessage = document.getElementById('loading-message');
        
        // Send API request
        apiRequestForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const url = apiUrlInput.value.trim();
            const method = requestMethodSelect.value;
            
            if (!url) {
                showAlert('Please enter a URL', 'warning');
                return;
            }
            
            // Parse headers
            let headers = {};
            if (requestHeadersInput.value.trim()) {
                try {
                    headers = JSON.parse(requestHeadersInput.value);
                } catch (error) {
                    showAlert('Invalid JSON in headers', 'danger');
                    return;
                }
            }
            
            // Parse params
            let params = {};
            if (requestParamsInput.value.trim()) {
                try {
                    params = JSON.parse(requestParamsInput.value);
                } catch (error) {
                    showAlert('Invalid JSON in query parameters', 'danger');
                    return;
                }
            }
            
            // Parse body
            let body = null;
            if (requestBodyInput.value.trim() && ['POST', 'PUT', 'PATCH'].includes(method)) {
                try {
                    body = JSON.parse(requestBodyInput.value);
                } catch (error) {
                    showAlert('Invalid JSON in request body', 'danger');
                    return;
                }
            }
            
            // Get timeout
            const timeout = parseInt(requestTimeoutInput.value) || 30;
            
            // Show loading
            loadingMessage.textContent = 'Sending API request...';
            loadingModal.show();
            
            // Record start time
            const startTime = performance.now();
            
            // Send request
            fetch('/api/external/fetch', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    url: url,
                    method: method,
                    headers: headers,
                    params: params,
                    data: body,
                    timeout: timeout
                })
            })
                .then(response => response.json())
                .then(data => {
                    // Calculate time taken
                    const endTime = performance.now();
                    const timeTaken = endTime - startTime;
                    
                    loadingModal.hide();
                    
                    if (data.status === 'success') {
                        displayResponse(data.data, timeTaken);
                    } else {
                        showErrorResponse(data.message || 'Failed to fetch data');
                    }
                })
                .catch(error => {
                    loadingModal.hide();
                    console.error('Error sending API request:', error);
                    showErrorResponse(error.message);
                });
        });
        
        // Download file
        fileDownloadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const url = downloadUrlInput.value.trim();
            const destination = downloadDestinationInput.value.trim();
            
            if (!url) {
                showAlert('Please enter a URL', 'warning');
                return;
            }
            
            if (!destination) {
                showAlert('Please enter a destination path', 'warning');
                return;
            }
            
            // Show loading
            loadingMessage.textContent = 'Downloading file...';
            loadingModal.show();
            
            fetch('/api/external/download', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    url: url,
                    destination: destination
                })
            })
                .then(response => response.json())
                .then(data => {
                    loadingModal.hide();
                    
                    if (data.status === 'success') {
                        showAlert(`File downloaded successfully to ${data.path}`, 'success');
                        
                        // Display download information
                        displayTextResponse(`File downloaded successfully to: ${data.path}`);
                    } else {
                        showAlert(data.message || 'Failed to download file', 'danger');
                        showErrorResponse(data.message || 'Failed to download file');
                    }
                })
                .catch(error => {
                    loadingModal.hide();
                    console.error('Error downloading file:', error);
                    showAlert(`Error: ${error.message}`, 'danger');
                    showErrorResponse(error.message);
                });
        });
        
        // Copy response
        copyResponseBtn.addEventListener('click', function() {
            const content = responseContainer.textContent;
            navigator.clipboard.writeText(content)
                .then(() => {
                    showAlert('Response copied to clipboard!', 'success');
                })
                .catch(err => {
                    console.error('Failed to copy text: ', err);
                    showAlert('Failed to copy to clipboard', 'danger');
                });
        });
        
        // Clear response
        clearResponseBtn.addEventListener('click', function() {
            responseContainer.innerHTML = `
                <div class="text-center text-muted py-5">
                    <i data-feather="inbox" style="width: 48px; height: 48px;"></i>
                    <p class="mt-3">Send a request to see the response</p>
                </div>
            `;
            feather.replace();
            
            responseMetadata.classList.add('d-none');
        });
        
        // Save Request
        saveRequestBtn.addEventListener('click', function() {
            const url = apiUrlInput.value.trim();
            
            if (!url) {
                showAlert('Please enter a URL before saving', 'warning');
                return;
            }
            
            requestNameInput.value = generateRequestName(url);
            requestDescriptionInput.value = '';
            saveRequestModal.show();
        });
        
        saveRequestSubmit.addEventListener('click', function() {
            const name = requestNameInput.value.trim();
            
            if (!name) {
                showAlert('Please enter a name for the request', 'warning');
                return;
            }
            
            // Get current request details
            const requestData = {
                name: name,
                description: requestDescriptionInput.value.trim(),
                url: apiUrlInput.value.trim(),
                method: requestMethodSelect.value,
                headers: requestHeadersInput.value.trim(),
                params: requestParamsInput.value.trim(),
                body: requestBodyInput.value.trim(),
                timeout: requestTimeoutInput.value,
                created: new Date().toISOString()
            };
            
            // Save to local storage
            const savedRequests = JSON.parse(localStorage.getItem('api_saved_requests') || '[]');
            savedRequests.push({
                id: Date.now().toString(),
                ...requestData
            });
            
            localStorage.setItem('api_saved_requests', JSON.stringify(savedRequests));
            saveRequestModal.hide();
            
            showAlert(`Request "${name}" saved successfully!`, 'success');
            loadSavedRequests();
        });
        
        // URL Encode/Decode
        urlEncodeBtn.addEventListener('click', function() {
            urlInput.value = '';
            urlOutput.value = '';
            urlEncodeModal.show();
        });
        
        urlEncodeActionBtn.addEventListener('click', function() {
            const input = urlInput.value;
            urlOutput.value = encodeURIComponent(input);
        });
        
        urlDecodeActionBtn.addEventListener('click', function() {
            const input = urlInput.value;
            try {
                urlOutput.value = decodeURIComponent(input);
            } catch (error) {
                showAlert('Error decoding URL: Invalid input', 'danger');
                urlOutput.value = 'Error: Invalid URL encoding';
            }
        });
        
        urlCopyOutputBtn.addEventListener('click', function() {
            urlOutput.select();
            navigator.clipboard.writeText(urlOutput.value)
                .then(() => {
                    showAlert('Copied to clipboard!', 'success');
                })
                .catch(err => {
                    console.error('Failed to copy text: ', err);
                    showAlert('Failed to copy to clipboard', 'danger');
                });
        });
        
        // Base64 Encode/Decode
        base64Btn.addEventListener('click', function() {
            base64Input.value = '';
            base64Output.value = '';
            base64Modal.show();
        });
        
        base64EncodeActionBtn.addEventListener('click', function() {
            const input = base64Input.value;
            try {
                base64Output.value = btoa(input);
            } catch (error) {
                showAlert('Error encoding to Base64: ' + error.message, 'danger');
                base64Output.value = 'Error: Could not encode to Base64';
            }
        });
        
        base64DecodeActionBtn.addEventListener('click', function() {
            const input = base64Input.value;
            try {
                base64Output.value = atob(input);
            } catch (error) {
                showAlert('Error decoding from Base64: ' + error.message, 'danger');
                base64Output.value = 'Error: Invalid Base64 input';
            }
        });
        
        base64CopyOutputBtn.addEventListener('click', function() {
            base64Output.select();
            navigator.clipboard.writeText(base64Output.value)
                .then(() => {
                    showAlert('Copied to clipboard!', 'success');
                })
                .catch(err => {
                    console.error('Failed to copy text: ', err);
                    showAlert('Failed to copy to clipboard', 'danger');
                });
        });
        
        // JSON Formatter
        jsonFormatterBtn.addEventListener('click', function() {
            jsonInput.value = '';
            jsonOutput.value = '';
            jsonFormatterModal.show();
        });
        
        jsonFormatActionBtn.addEventListener('click', function() {
            const input = jsonInput.value.trim();
            try {
                const parsed = JSON.parse(input);
                jsonOutput.value = JSON.stringify(parsed, null, 2);
            } catch (error) {
                showAlert('Invalid JSON: ' + error.message, 'danger');
                jsonOutput.value = 'Error: Invalid JSON';
            }
        });
        
        jsonMinifyActionBtn.addEventListener('click', function() {
            const input = jsonInput.value.trim();
            try {
                const parsed = JSON.parse(input);
                jsonOutput.value = JSON.stringify(parsed);
            } catch (error) {
                showAlert('Invalid JSON: ' + error.message, 'danger');
                jsonOutput.value = 'Error: Invalid JSON';
            }
        });
        
        jsonCopyOutputBtn.addEventListener('click', function() {
            jsonOutput.select();
            navigator.clipboard.writeText(jsonOutput.value)
                .then(() => {
                    showAlert('Copied to clipboard!', 'success');
                })
                .catch(err => {
                    console.error('Failed to copy text: ', err);
                    showAlert('Failed to copy to clipboard', 'danger');
                });
        });
        
        // Display response
        function displayResponse(data, timeTaken) {
            let content;
            
            // Check if data is JSON
            if (typeof data === 'object') {
                content = JSON.stringify(data, null, 2);
                responseContainer.innerHTML = `<pre><code>${escapeHtml(content)}</code></pre>`;
            } else if (typeof data === 'string') {
                // Check if data is JSON string
                try {
                    const parsed = JSON.parse(data);
                    content = JSON.stringify(parsed, null, 2);
                    responseContainer.innerHTML = `<pre><code>${escapeHtml(content)}</code></pre>`;
                } catch (e) {
                    // If not JSON, just display as text
                    content = data;
                    displayTextResponse(content);
                }
            } else {
                content = String(data);
                displayTextResponse(content);
            }
            
            // Update metadata
            responseStatus.textContent = '200 OK';
            responseTime.textContent = Math.round(timeTaken);
            responseSize.textContent = formatBytes(new Blob([content]).size);
            responseMetadata.classList.remove('d-none');
        }
        
        // Display text response
        function displayTextResponse(text) {
            responseContainer.innerHTML = `<div class="text-wrap">${escapeHtml(text)}</div>`;
        }
        
        // Show error response
        function showErrorResponse(error) {
            responseContainer.innerHTML = `
                <div class="alert alert-danger">
                    <strong>Error:</strong> ${escapeHtml(error)}
                </div>
            `;
            
            responseMetadata.classList.add('d-none');
        }
        
        // Load saved requests
        function loadSavedRequests() {
            const savedRequests = JSON.parse(localStorage.getItem('api_saved_requests') || '[]');
            
            if (savedRequests.length === 0) {
                savedRequestsContainer.innerHTML = `
                    <div class="text-center text-muted">
                        <p>No saved requests</p>
                    </div>
                `;
                return;
            }
            
            // Sort by creation date (newest first)
            savedRequests.sort((a, b) => new Date(b.created) - new Date(a.created));
            
            let html = `<div class="list-group">`;
            
            savedRequests.forEach(request => {
                html += `
                    <div class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${escapeHtml(request.name)}</h6>
                            <small class="badge bg-secondary">${request.method}</small>
                        </div>
                        <p class="mb-1 text-truncate"><small>${escapeHtml(request.url)}</small></p>
                        ${request.description ? `<p class="text-muted small mb-1">${escapeHtml(request.description)}</p>` : ''}
                        <div class="d-flex justify-content-end mt-2">
                            <button class="btn btn-sm btn-outline-primary me-2 load-request-btn" data-id="${request.id}">
                                <i data-feather="refresh-cw" class="me-1"></i>Load
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-request-btn" data-id="${request.id}">
                                <i data-feather="trash-2" class="me-1"></i>Delete
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            savedRequestsContainer.innerHTML = html;
            feather.replace();
            
            // Add event listeners
            document.querySelectorAll('.load-request-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const requestId = this.dataset.id;
                    loadRequest(requestId);
                });
            });
            
            document.querySelectorAll('.delete-request-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const requestId = this.dataset.id;
                    deleteRequest(requestId);
                });
            });
        }
        
        // Load a saved request
        function loadRequest(requestId) {
            const savedRequests = JSON.parse(localStorage.getItem('api_saved_requests') || '[]');
            const request = savedRequests.find(r => r.id === requestId);
            
            if (!request) return;
            
            apiUrlInput.value = request.url || '';
            requestMethodSelect.value = request.method || 'GET';
            requestHeadersInput.value = request.headers || '';
            requestParamsInput.value = request.params || '';
            requestBodyInput.value = request.body || '';
            requestTimeoutInput.value = request.timeout || '30';
            
            showAlert(`Request "${request.name}" loaded successfully!`, 'success');
        }
        
        // Delete a saved request
        function deleteRequest(requestId) {
            if (!confirm('Are you sure you want to delete this request?')) {
                return;
            }
            
            const savedRequests = JSON.parse(localStorage.getItem('api_saved_requests') || '[]');
            const filteredRequests = savedRequests.filter(r => r.id !== requestId);
            
            localStorage.setItem('api_saved_requests', JSON.stringify(filteredRequests));
            showAlert('Request deleted successfully!', 'success');
            loadSavedRequests();
        }
        
        // Generate a name for the request based on URL
        function generateRequestName(url) {
            try {
                const parsedUrl = new URL(url);
                const hostname = parsedUrl.hostname;
                const pathname = parsedUrl.pathname;
                
                // Extract last part of the path
                const pathParts = pathname.split('/').filter(p => p);
                const lastPath = pathParts.length > 0 ? pathParts[pathParts.length - 1] : '';
                
                // Combine hostname and path
                if (lastPath) {
                    return `${hostname} - ${lastPath}`;
                } else {
                    return hostname;
                }
            } catch (e) {
                // If URL parsing fails, just use part of the URL
                const parts = url.split('/');
                return parts[parts.length - 1] || url.substring(0, 30);
            }
        }
        
        // Format bytes to human-readable format
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
            
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }
        
        // Helper function to escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Initial load
        loadSavedRequests();
    });
</script>
{% endblock %}
