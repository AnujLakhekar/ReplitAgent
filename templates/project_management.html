{% extends "layout.html" %}

{% block title %}Replit Agent - Project Management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12 mb-4">
        <h2><i data-feather="folder" class="me-2"></i>Project Management</h2>
        <p class="lead">Create and manage your projects with various templates.</p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i data-feather="plus-circle" class="me-2"></i>Create Project</h5>
            </div>
            <div class="card-body">
                <form id="create-project-form">
                    <div class="mb-3">
                        <label for="project-name" class="form-label">Project Name</label>
                        <input type="text" class="form-control" id="project-name" placeholder="Enter project name">
                    </div>
                    <div class="mb-3">
                        <label for="project-template" class="form-label">Project Template</label>
                        <select class="form-select" id="project-template">
                            <option value="">None (Basic Structure)</option>
                            <option value="python">Python</option>
                            <option value="web">Web (HTML/CSS/JS)</option>
                            <option value="flask">Flask Web Application</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="project-description" class="form-label">Description (optional)</label>
                        <textarea class="form-control" id="project-description" rows="3" placeholder="Enter project description"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i data-feather="folder-plus" class="me-1"></i>Create Project
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i data-feather="list" class="me-2"></i>Project List</h5>
                    <button class="btn btn-sm btn-outline-secondary" id="refresh-projects-btn">
                        <i data-feather="refresh-cw" class="me-1"></i>Refresh
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="input-group mb-3">
                    <span class="input-group-text"><i data-feather="search"></i></span>
                    <input type="text" class="form-control" id="project-search" placeholder="Search projects...">
                </div>
                <div id="project-list" class="row row-cols-1 row-cols-md-2 g-4">
                    <div class="col text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading projects...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i data-feather="info" class="me-2"></i>Project Templates</h5>
            </div>
            <div class="card-body">
                <div class="accordion" id="templatesAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingOne">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                Python Template
                            </button>
                        </h2>
                        <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#templatesAccordion">
                            <div class="accordion-body">
                                <p>The Python template creates a basic Python project structure with the following files and directories:</p>
                                <ul>
                                    <li><code>main.py</code> - Main entry point for the application</li>
                                    <li><code>requirements.txt</code> - File for listing dependencies</li>
                                    <li><code>README.md</code> - Project documentation</li>
                                    <li><code>src/</code> - Directory for source code</li>
                                    <li><code>tests/</code> - Directory for test files</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingTwo">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                Web Template
                            </button>
                        </h2>
                        <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#templatesAccordion">
                            <div class="accordion-body">
                                <p>The Web template creates a basic web project structure with the following files and directories:</p>
                                <ul>
                                    <li><code>index.html</code> - Main HTML file</li>
                                    <li><code>styles.css</code> - CSS stylesheet</li>
                                    <li><code>script.js</code> - JavaScript file</li>
                                    <li><code>README.md</code> - Project documentation</li>
                                    <li><code>assets/</code> - Directory for images and other assets</li>
                                    <li><code>js/</code> - Directory for JavaScript files</li>
                                    <li><code>css/</code> - Directory for CSS files</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingThree">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                Flask Template
                            </button>
                        </h2>
                        <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#templatesAccordion">
                            <div class="accordion-body">
                                <p>The Flask template creates a basic Flask web application structure with the following files and directories:</p>
                                <ul>
                                    <li><code>app.py</code> - Main Flask application file</li>
                                    <li><code>requirements.txt</code> - File listing dependencies (includes Flask)</li>
                                    <li><code>README.md</code> - Project documentation</li>
                                    <li><code>static/</code> - Directory for static files (CSS, JavaScript, images)</li>
                                    <li><code>templates/</code> - Directory for HTML templates</li>
                                    <li><code>templates/index.html</code> - Main template file</li>
                                    <li><code>routes/</code> - Directory for route handlers</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Project Details Modal -->
<div class="modal fade" id="project-details-modal" tabindex="-1" aria-labelledby="project-details-label" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="project-details-label">Project Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="project-details-content">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading project details...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger" id="delete-project-btn">
                    <i data-feather="trash-2" class="me-1"></i>Delete Project
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Project Metadata Modal -->
<div class="modal fade" id="edit-metadata-modal" tabindex="-1" aria-labelledby="edit-metadata-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="edit-metadata-label">Edit Project Metadata</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="edit-metadata-form">
                    <div class="mb-3">
                        <label for="edit-project-name" class="form-label">Project Name</label>
                        <input type="text" class="form-control" id="edit-project-name" disabled>
                    </div>
                    <div class="mb-3">
                        <label for="edit-project-description" class="form-label">Description</label>
                        <textarea class="form-control" id="edit-project-description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="edit-project-version" class="form-label">Version</label>
                        <input type="text" class="form-control" id="edit-project-version">
                    </div>
                    <input type="hidden" id="edit-project-id">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-metadata-btn">Save Changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Elements
        const createProjectForm = document.getElementById('create-project-form');
        const projectNameInput = document.getElementById('project-name');
        const projectTemplateSelect = document.getElementById('project-template');
        const projectDescriptionInput = document.getElementById('project-description');
        const projectSearchInput = document.getElementById('project-search');
        const projectList = document.getElementById('project-list');
        const refreshProjectsBtn = document.getElementById('refresh-projects-btn');
        
        // Modal elements
        const projectDetailsModal = new bootstrap.Modal(document.getElementById('project-details-modal'));
        const projectDetailsContent = document.getElementById('project-details-content');
        const deleteProjectBtn = document.getElementById('delete-project-btn');
        
        // Edit metadata modal elements
        const editMetadataModal = new bootstrap.Modal(document.getElementById('edit-metadata-modal'));
        const editProjectName = document.getElementById('edit-project-name');
        const editProjectDescription = document.getElementById('edit-project-description');
        const editProjectVersion = document.getElementById('edit-project-version');
        const editProjectId = document.getElementById('edit-project-id');
        const saveMetadataBtn = document.getElementById('save-metadata-btn');
        
        let currentProjects = [];
        let selectedProject = null;
        
        // Load projects
        function loadProjects() {
            projectList.innerHTML = `
                <div class="col text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading projects...</p>
                </div>
            `;
            
            fetch('/api/project/list')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        currentProjects = data.projects || [];
                        renderProjects(currentProjects);
                    } else {
                        showAlert(data.message || 'Failed to load projects', 'danger');
                        projectList.innerHTML = `<div class="col text-center">Error loading projects</div>`;
                    }
                })
                .catch(error => {
                    console.error('Error loading projects:', error);
                    projectList.innerHTML = `<div class="col text-center">Error: ${error.message}</div>`;
                });
        }
        
        // Render projects
        function renderProjects(projects) {
            if (!projects || projects.length === 0) {
                projectList.innerHTML = `
                    <div class="col text-center">
                        <div class="alert alert-info">
                            No projects found. Create your first project!
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            projects.forEach(project => {
                const createdDate = new Date(project.created_at).toLocaleDateString();
                html += `
                    <div class="col">
                        <div class="card project-card h-100">
                            <div class="card-header">
                                <h5 class="mb-0">${escapeHtml(project.name)}</h5>
                                <span class="badge bg-info">${project.version || '0.1.0'}</span>
                            </div>
                            <div class="card-body">
                                <p class="card-text">${escapeHtml(project.description || 'No description provided.')}</p>
                                <p class="card-text"><small class="text-muted">Created: ${createdDate}</small></p>
                            </div>
                            <div class="card-footer">
                                <button class="btn btn-sm btn-primary view-project-btn" data-name="${project.name}">
                                    <i data-feather="eye" class="me-1"></i>View Details
                                </button>
                                <button class="btn btn-sm btn-outline-secondary edit-metadata-btn" data-name="${project.name}">
                                    <i data-feather="edit" class="me-1"></i>Edit
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            projectList.innerHTML = html;
            feather.replace();
            
            // Add event listeners
            document.querySelectorAll('.view-project-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const projectName = this.dataset.name;
                    viewProjectDetails(projectName);
                });
            });
            
            document.querySelectorAll('.edit-metadata-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const projectName = this.dataset.name;
                    editProjectMetadata(projectName);
                });
            });
        }
        
        // View project details
        function viewProjectDetails(projectName) {
            selectedProject = projectName;
            
            projectDetailsContent.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading project details...</p>
                </div>
            `;
            
            projectDetailsModal.show();
            
            fetch(`/api/project/info?name=${encodeURIComponent(projectName)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const projectInfo = data.project_info;
                        renderProjectDetails(projectInfo);
                    } else {
                        projectDetailsContent.innerHTML = `
                            <div class="alert alert-danger">
                                ${data.message || 'Failed to load project details'}
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error loading project details:', error);
                    projectDetailsContent.innerHTML = `
                        <div class="alert alert-danger">
                            Error: ${error.message}
                        </div>
                    `;
                });
        }
        
        // Render project details
        function renderProjectDetails(projectInfo) {
            const createdDate = new Date(projectInfo.created_at).toLocaleDateString();
            const updatedDate = projectInfo.updated_at ? new Date(projectInfo.updated_at).toLocaleDateString() : 'Never';
            
            let html = `
                <div class="row mb-4">
                    <div class="col-md-8">
                        <h4>${escapeHtml(projectInfo.name)}</h4>
                        <p>${escapeHtml(projectInfo.description || 'No description provided.')}</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <span class="badge bg-info fs-6">${projectInfo.version || '0.1.0'}</span>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><strong>Created:</strong> ${createdDate}</p>
                        <p><strong>Updated:</strong> ${updatedDate}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Created By:</strong> ${escapeHtml(projectInfo.created_by || 'Unknown')}</p>
                    </div>
                </div>
            `;
            
            // Additional metadata
            if (projectInfo.metadata) {
                html += `
                    <div class="mb-3">
                        <h5>Additional Metadata</h5>
                        <div class="card">
                            <div class="card-body">
                                <pre class="m-0"><code>${JSON.stringify(projectInfo.metadata, null, 2)}</code></pre>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Project structure (if available)
            if (projectInfo.structure && projectInfo.structure.length > 0) {
                html += `
                    <div class="mb-3">
                        <h5>Project Structure</h5>
                        <div class="card">
                            <div class="card-body">
                                <ul class="list-group">
                `;
                
                projectInfo.structure.forEach(item => {
                    const icon = item.type === 'directory' ? 'folder' : 'file-text';
                    html += `
                        <li class="list-group-item d-flex align-items-center">
                            <i data-feather="${icon}" class="me-2"></i>
                            ${item.path}
                        </li>
                    `;
                });
                
                html += `
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Actions
            html += `
                <div class="d-flex justify-content-end mt-4">
                    <button class="btn btn-outline-primary me-2" id="open-project-btn">
                        <i data-feather="folder-open" class="me-1"></i>Open Files
                    </button>
                    <button class="btn btn-outline-secondary" id="edit-project-metadata-btn">
                        <i data-feather="edit" class="me-1"></i>Edit Metadata
                    </button>
                </div>
            `;
            
            projectDetailsContent.innerHTML = html;
            feather.replace();
            
            // Add event listeners
            document.getElementById('open-project-btn').addEventListener('click', function() {
                window.location.href = `/file-operations?path=${encodeURIComponent(projectInfo.name)}`;
            });
            
            document.getElementById('edit-project-metadata-btn').addEventListener('click', function() {
                editProjectMetadata(projectInfo.name);
                projectDetailsModal.hide();
            });
        }
        
        // Edit project metadata
        function editProjectMetadata(projectName) {
            const project = currentProjects.find(p => p.name === projectName);
            
            if (project) {
                editProjectName.value = project.name;
                editProjectDescription.value = project.description || '';
                editProjectVersion.value = project.version || '0.1.0';
                editProjectId.value = project.name;
                
                editMetadataModal.show();
            } else {
                showAlert(`Project ${projectName} not found`, 'danger');
            }
        }
        
        // Filter projects
        projectSearchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            
            if (!searchTerm) {
                renderProjects(currentProjects);
                return;
            }
            
            const filteredProjects = currentProjects.filter(project => {
                return project.name.toLowerCase().includes(searchTerm) || 
                       (project.description && project.description.toLowerCase().includes(searchTerm));
            });
            
            renderProjects(filteredProjects);
        });
        
        // Refresh projects
        refreshProjectsBtn.addEventListener('click', loadProjects);
        
        // Create project form submission
        createProjectForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const projectName = projectNameInput.value.trim();
            const projectTemplate = projectTemplateSelect.value;
            const projectDescription = projectDescriptionInput.value.trim();
            
            if (!projectName) {
                showAlert('Please enter a project name', 'warning');
                return;
            }
            
            // Disable form
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Creating...';
            
            // Create project
            fetch('/api/project/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: projectName,
                    template: projectTemplate,
                    description: projectDescription
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showAlert(`Project ${projectName} created successfully!`, 'success');
                        
                        // Reset form
                        createProjectForm.reset();
                        
                        // Reload projects
                        loadProjects();
                    } else {
                        showAlert(data.message || 'Failed to create project', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error creating project:', error);
                    showAlert(`Error: ${error.message}`, 'danger');
                })
                .finally(() => {
                    // Re-enable form
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                });
        });
        
        // Delete project
        deleteProjectBtn.addEventListener('click', function() {
            if (!selectedProject) return;
            
            if (!confirm(`Are you sure you want to delete project ${selectedProject}? This action cannot be undone.`)) {
                return;
            }
            
            fetch('/api/project/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: selectedProject
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showAlert(`Project ${selectedProject} deleted successfully!`, 'success');
                        
                        // Hide modal
                        projectDetailsModal.hide();
                        
                        // Reset selected project
                        selectedProject = null;
                        
                        // Reload projects
                        loadProjects();
                    } else {
                        showAlert(data.message || 'Failed to delete project', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error deleting project:', error);
                    showAlert(`Error: ${error.message}`, 'danger');
                });
        });
        
        // Save metadata
        saveMetadataBtn.addEventListener('click', function() {
            const projectName = editProjectId.value;
            const projectDescription = editProjectDescription.value.trim();
            const projectVersion = editProjectVersion.value.trim();
            
            if (!projectName) return;
            
            fetch('/api/project/update-metadata', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: projectName,
                    metadata: {
                        description: projectDescription,
                        version: projectVersion
                    }
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showAlert(`Project metadata updated successfully!`, 'success');
                        
                        // Hide modal
                        editMetadataModal.hide();
                        
                        // Reload projects
                        loadProjects();
                    } else {
                        showAlert(data.message || 'Failed to update project metadata', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error updating project metadata:', error);
                    showAlert(`Error: ${error.message}`, 'danger');
                });
        });
        
        // Helper function to escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Initial load
        loadProjects();
    });
</script>
{% endblock %}
