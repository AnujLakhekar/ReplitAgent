{% extends "layout.html" %}

{% block title %}Replit Agent - AI Features{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12 mb-4">
        <h2><i data-feather="cpu" class="me-2"></i>AI Features</h2>
        <p class="lead">Generate code, explain code, suggest improvements, and more with AI assistance.</p>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i data-feather="code" class="me-2"></i>Code Generation</h5>
            </div>
            <div class="card-body">
                <form id="code-generation-form">
                    <div class="mb-3">
                        <label for="generation-prompt" class="form-label">Describe what you need</label>
                        <textarea class="form-control" id="generation-prompt" rows="4" placeholder="e.g., Create a Python function that sorts a list of dictionaries by a specified key"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="generation-language" class="form-label">Programming Language</label>
                        <select class="form-select" id="generation-language">
                            <option value="python" selected>Python</option>
                            <option value="javascript">JavaScript</option>
                            <option value="html">HTML</option>
                            <option value="css">CSS</option>
                            <option value="bash">Bash</option>
                            <option value="ruby">Ruby</option>
                            <option value="java">Java</option>
                            <option value="csharp">C#</option>
                            <option value="php">PHP</option>
                            <option value="go">Go</option>
                            <option value="rust">Rust</option>
                            <option value="sql">SQL</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i data-feather="play" class="me-1"></i>Generate Code
                    </button>
                </form>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i data-feather="help-circle" class="me-2"></i>Code Explanation</h5>
            </div>
            <div class="card-body">
                <form id="code-explanation-form">
                    <div class="mb-3">
                        <label for="explanation-code" class="form-label">Paste code to explain</label>
                        <textarea class="form-control" id="explanation-code" rows="8" placeholder="Paste the code you want to understand..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i data-feather="book-open" class="me-1"></i>Explain Code
                    </button>
                </form>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i data-feather="tool" class="me-2"></i>Code Improvements</h5>
            </div>
            <div class="card-body">
                <form id="code-improvements-form">
                    <div class="mb-3">
                        <label for="improvements-code" class="form-label">Paste code to improve</label>
                        <textarea class="form-control" id="improvements-code" rows="8" placeholder="Paste the code you want to improve..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="improvements-language" class="form-label">Programming Language</label>
                        <select class="form-select" id="improvements-language">
                            <option value="python" selected>Python</option>
                            <option value="javascript">JavaScript</option>
                            <option value="java">Java</option>
                            <option value="csharp">C#</option>
                            <option value="go">Go</option>
                            <option value="php">PHP</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i data-feather="zap" class="me-1"></i>Suggest Improvements
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i data-feather="message-square" class="me-2"></i>AI Response</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" id="copy-response-btn">
                            <i data-feather="copy" class="me-1"></i>Copy
                        </button>
                        <button class="btn btn-sm btn-outline-secondary ms-2" id="clear-response-btn">
                            <i data-feather="trash-2" class="me-1"></i>Clear
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="ai-response" class="min-height-400">
                    <div class="text-center text-muted py-5">
                        <i data-feather="cpu" style="width: 48px; height: 48px;"></i>
                        <p class="mt-3">Use the tools on the left to generate AI responses</p>
                        <div class="alert alert-info mt-3">
                            <i data-feather="info" class="me-2"></i>
                            <strong>No API Key Available:</strong> The application is running in simulation mode. 
                            Responses will be placeholders. For full AI functionality, add an OpenAI API key.
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i data-feather="command" class="me-2"></i>More AI Tools</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" id="generate-tests-btn">
                        <i data-feather="check-square" class="me-1"></i>Generate Unit Tests
                    </button>
                    <button class="btn btn-outline-primary" id="translate-code-btn">
                        <i data-feather="refresh-cw" class="me-1"></i>Translate Code to Another Language
                    </button>
                    <button class="btn btn-outline-primary" id="debug-code-btn">
                        <i data-feather="alert-triangle" class="me-1"></i>Debug Code
                    </button>
                    <button class="btn btn-outline-primary" id="generate-docs-btn">
                        <i data-feather="file-text" class="me-1"></i>Generate Documentation
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i data-feather="save" class="me-2"></i>Saved Prompts</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <button class="btn btn-sm btn-outline-primary" id="save-prompt-btn">
                        <i data-feather="save" class="me-1"></i>Save Current Prompt
                    </button>
                </div>
                <div id="saved-prompts-container">
                    <div class="text-center text-muted">
                        <p>No saved prompts</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Generate Tests Modal -->
<div class="modal fade" id="generate-tests-modal" tabindex="-1" aria-labelledby="generate-tests-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="generate-tests-modal-label">Generate Unit Tests</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="generate-tests-form">
                    <div class="mb-3">
                        <label for="tests-code" class="form-label">Paste code to generate tests for</label>
                        <textarea class="form-control" id="tests-code" rows="10" placeholder="Paste your code here..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="tests-language" class="form-label">Programming Language</label>
                        <select class="form-select" id="tests-language">
                            <option value="python" selected>Python</option>
                            <option value="javascript">JavaScript</option>
                            <option value="java">Java</option>
                            <option value="csharp">C#</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="generate-tests-submit">Generate Tests</button>
            </div>
        </div>
    </div>
</div>

<!-- Translate Code Modal -->
<div class="modal fade" id="translate-code-modal" tabindex="-1" aria-labelledby="translate-code-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="translate-code-modal-label">Translate Code</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="translate-code-form">
                    <div class="mb-3">
                        <label for="translate-code" class="form-label">Code to translate</label>
                        <textarea class="form-control" id="translate-code" rows="10" placeholder="Paste your code here..."></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="translate-source-language" class="form-label">Source Language</label>
                                <select class="form-select" id="translate-source-language">
                                    <option value="python" selected>Python</option>
                                    <option value="javascript">JavaScript</option>
                                    <option value="java">Java</option>
                                    <option value="csharp">C#</option>
                                    <option value="php">PHP</option>
                                    <option value="ruby">Ruby</option>
                                    <option value="go">Go</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="translate-target-language" class="form-label">Target Language</label>
                                <select class="form-select" id="translate-target-language">
                                    <option value="python">Python</option>
                                    <option value="javascript" selected>JavaScript</option>
                                    <option value="java">Java</option>
                                    <option value="csharp">C#</option>
                                    <option value="php">PHP</option>
                                    <option value="ruby">Ruby</option>
                                    <option value="go">Go</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="translate-code-submit">Translate</button>
            </div>
        </div>
    </div>
</div>

<!-- Debug Code Modal -->
<div class="modal fade" id="debug-code-modal" tabindex="-1" aria-labelledby="debug-code-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="debug-code-modal-label">Debug Code</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="debug-code-form">
                    <div class="mb-3">
                        <label for="debug-code" class="form-label">Code with errors</label>
                        <textarea class="form-control" id="debug-code" rows="10" placeholder="Paste your code with errors..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="debug-error" class="form-label">Error message (if any)</label>
                        <textarea class="form-control" id="debug-error" rows="3" placeholder="Paste any error messages here..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="debug-language" class="form-label">Programming Language</label>
                        <select class="form-select" id="debug-language">
                            <option value="python" selected>Python</option>
                            <option value="javascript">JavaScript</option>
                            <option value="java">Java</option>
                            <option value="csharp">C#</option>
                            <option value="php">PHP</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="debug-code-submit">Debug</button>
            </div>
        </div>
    </div>
</div>

<!-- Generate Documentation Modal -->
<div class="modal fade" id="generate-docs-modal" tabindex="-1" aria-labelledby="generate-docs-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="generate-docs-modal-label">Generate Documentation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="generate-docs-form">
                    <div class="mb-3">
                        <label for="docs-code" class="form-label">Code to document</label>
                        <textarea class="form-control" id="docs-code" rows="10" placeholder="Paste your code here..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="docs-language" class="form-label">Programming Language</label>
                        <select class="form-select" id="docs-language">
                            <option value="python" selected>Python</option>
                            <option value="javascript">JavaScript</option>
                            <option value="java">Java</option>
                            <option value="csharp">C#</option>
                            <option value="php">PHP</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="generate-docs-submit">Generate Documentation</button>
            </div>
        </div>
    </div>
</div>

<!-- Save Prompt Modal -->
<div class="modal fade" id="save-prompt-modal" tabindex="-1" aria-labelledby="save-prompt-modal-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="save-prompt-modal-label">Save Prompt</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="save-prompt-form">
                    <div class="mb-3">
                        <label for="prompt-name" class="form-label">Prompt Name</label>
                        <input type="text" class="form-control" id="prompt-name" placeholder="Enter a name for this prompt">
                    </div>
                    <div class="mb-3">
                        <label for="prompt-type" class="form-label">Prompt Type</label>
                        <select class="form-select" id="prompt-type">
                            <option value="generation">Code Generation</option>
                            <option value="explanation">Code Explanation</option>
                            <option value="improvements">Code Improvements</option>
                            <option value="tests">Generate Tests</option>
                            <option value="translation">Translate Code</option>
                            <option value="debug">Debug Code</option>
                            <option value="documentation">Generate Documentation</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="prompt-content" class="form-label">Prompt Content</label>
                        <textarea class="form-control" id="prompt-content" rows="4" readonly></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-prompt-submit">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Elements
        const codeGenerationForm = document.getElementById('code-generation-form');
        const generationPromptInput = document.getElementById('generation-prompt');
        const generationLanguageSelect = document.getElementById('generation-language');
        
        const codeExplanationForm = document.getElementById('code-explanation-form');
        const explanationCodeInput = document.getElementById('explanation-code');
        
        const codeImprovementsForm = document.getElementById('code-improvements-form');
        const improvementsCodeInput = document.getElementById('improvements-code');
        const improvementsLanguageSelect = document.getElementById('improvements-language');
        
        const aiResponse = document.getElementById('ai-response');
        const copyResponseBtn = document.getElementById('copy-response-btn');
        const clearResponseBtn = document.getElementById('clear-response-btn');
        
        // Modal buttons
        const generateTestsBtn = document.getElementById('generate-tests-btn');
        const translateCodeBtn = document.getElementById('translate-code-btn');
        const debugCodeBtn = document.getElementById('debug-code-btn');
        const generateDocsBtn = document.getElementById('generate-docs-btn');
        
        // Modal elements
        const generateTestsModal = new bootstrap.Modal(document.getElementById('generate-tests-modal'));
        const translateCodeModal = new bootstrap.Modal(document.getElementById('translate-code-modal'));
        const debugCodeModal = new bootstrap.Modal(document.getElementById('debug-code-modal'));
        const generateDocsModal = new bootstrap.Modal(document.getElementById('generate-docs-modal'));
        const savePromptModal = new bootstrap.Modal(document.getElementById('save-prompt-modal'));
        
        // Generate Tests form elements
        const testsCodeInput = document.getElementById('tests-code');
        const testsLanguageSelect = document.getElementById('tests-language');
        const generateTestsSubmit = document.getElementById('generate-tests-submit');
        
        // Translate Code form elements
        const translateCodeInput = document.getElementById('translate-code');
        const translateSourceLanguageSelect = document.getElementById('translate-source-language');
        const translateTargetLanguageSelect = document.getElementById('translate-target-language');
        const translateCodeSubmit = document.getElementById('translate-code-submit');
        
        // Debug Code form elements
        const debugCodeInput = document.getElementById('debug-code');
        const debugErrorInput = document.getElementById('debug-error');
        const debugLanguageSelect = document.getElementById('debug-language');
        const debugCodeSubmit = document.getElementById('debug-code-submit');
        
        // Generate Documentation form elements
        const docsCodeInput = document.getElementById('docs-code');
        const docsLanguageSelect = document.getElementById('docs-language');
        const generateDocsSubmit = document.getElementById('generate-docs-submit');
        
        // Save Prompt elements
        const savePromptBtn = document.getElementById('save-prompt-btn');
        const promptNameInput = document.getElementById('prompt-name');
        const promptTypeSelect = document.getElementById('prompt-type');
        const promptContentInput = document.getElementById('prompt-content');
        const savePromptSubmit = document.getElementById('save-prompt-submit');
        const savedPromptsContainer = document.getElementById('saved-prompts-container');
        
        let currentPromptType = null;
        let currentPromptContent = null;
        
        // Generate code
        codeGenerationForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const prompt = generationPromptInput.value.trim();
            const language = generationLanguageSelect.value;
            
            if (!prompt) {
                showAlert('Please enter a prompt', 'warning');
                return;
            }
            
            // Save current prompt for potential saving
            currentPromptType = 'generation';
            currentPromptContent = prompt;
            
            showLoadingResponse();
            
            fetch('/api/ai/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    prompt: prompt,
                    language: language
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showCodeResponse(data.generated_code, 'Code Generation Response:');
                    } else {
                        showErrorResponse(data.message || 'Failed to generate code');
                    }
                })
                .catch(error => {
                    console.error('Error generating code:', error);
                    showErrorResponse(error.message);
                });
        });
        
        // Explain code
        codeExplanationForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const code = explanationCodeInput.value.trim();
            
            if (!code) {
                showAlert('Please enter code to explain', 'warning');
                return;
            }
            
            // Save current prompt for potential saving
            currentPromptType = 'explanation';
            currentPromptContent = code;
            
            showLoadingResponse();
            
            fetch('/api/ai/explain', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    code: code
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showTextResponse(data.explanation, 'Code Explanation:');
                    } else {
                        showErrorResponse(data.message || 'Failed to explain code');
                    }
                })
                .catch(error => {
                    console.error('Error explaining code:', error);
                    showErrorResponse(error.message);
                });
        });
        
        // Suggest improvements
        codeImprovementsForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const code = improvementsCodeInput.value.trim();
            const language = improvementsLanguageSelect.value;
            
            if (!code) {
                showAlert('Please enter code to improve', 'warning');
                return;
            }
            
            // Save current prompt for potential saving
            currentPromptType = 'improvements';
            currentPromptContent = code;
            
            showLoadingResponse();
            
            fetch('/api/ai/improve', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    code: code,
                    language: language
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showImprovementsResponse(data.suggestions);
                    } else {
                        showErrorResponse(data.message || 'Failed to suggest improvements');
                    }
                })
                .catch(error => {
                    console.error('Error suggesting improvements:', error);
                    showErrorResponse(error.message);
                });
        });
        
        // Generate tests
        generateTestsBtn.addEventListener('click', function() {
            generateTestsModal.show();
        });
        
        generateTestsSubmit.addEventListener('click', function() {
            const code = testsCodeInput.value.trim();
            const language = testsLanguageSelect.value;
            
            if (!code) {
                showAlert('Please enter code to generate tests for', 'warning');
                return;
            }
            
            // Save current prompt for potential saving
            currentPromptType = 'tests';
            currentPromptContent = code;
            
            showLoadingResponse();
            generateTestsModal.hide();
            
            fetch('/api/ai/generate-tests', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    code: code,
                    language: language
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showCodeResponse(data.tests, 'Generated Unit Tests:');
                    } else {
                        showErrorResponse(data.message || 'Failed to generate tests');
                    }
                })
                .catch(error => {
                    console.error('Error generating tests:', error);
                    showErrorResponse(error.message);
                });
        });
        
        // Translate code
        translateCodeBtn.addEventListener('click', function() {
            translateCodeModal.show();
        });
        
        translateCodeSubmit.addEventListener('click', function() {
            const code = translateCodeInput.value.trim();
            const sourceLanguage = translateSourceLanguageSelect.value;
            const targetLanguage = translateTargetLanguageSelect.value;
            
            if (!code) {
                showAlert('Please enter code to translate', 'warning');
                return;
            }
            
            if (sourceLanguage === targetLanguage) {
                showAlert('Source and target languages must be different', 'warning');
                return;
            }
            
            // Save current prompt for potential saving
            currentPromptType = 'translation';
            currentPromptContent = code;
            
            showLoadingResponse();
            translateCodeModal.hide();
            
            fetch('/api/ai/translate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    code: code,
                    source_language: sourceLanguage,
                    target_language: targetLanguage
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showCodeResponse(data.translated_code, `Translated from ${sourceLanguage} to ${targetLanguage}:`);
                    } else {
                        showErrorResponse(data.message || 'Failed to translate code');
                    }
                })
                .catch(error => {
                    console.error('Error translating code:', error);
                    showErrorResponse(error.message);
                });
        });
        
        // Debug code
        debugCodeBtn.addEventListener('click', function() {
            debugCodeModal.show();
        });
        
        debugCodeSubmit.addEventListener('click', function() {
            const code = debugCodeInput.value.trim();
            const errorMessage = debugErrorInput.value.trim();
            const language = debugLanguageSelect.value;
            
            if (!code) {
                showAlert('Please enter code to debug', 'warning');
                return;
            }
            
            // Save current prompt for potential saving
            currentPromptType = 'debug';
            currentPromptContent = code;
            
            showLoadingResponse();
            debugCodeModal.hide();
            
            fetch('/api/ai/debug', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    code: code,
                    error_message: errorMessage,
                    language: language
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showDebugResponse(data.debug_results);
                    } else {
                        showErrorResponse(data.message || 'Failed to debug code');
                    }
                })
                .catch(error => {
                    console.error('Error debugging code:', error);
                    showErrorResponse(error.message);
                });
        });
        
        // Generate documentation
        generateDocsBtn.addEventListener('click', function() {
            generateDocsModal.show();
        });
        
        generateDocsSubmit.addEventListener('click', function() {
            const code = docsCodeInput.value.trim();
            const language = docsLanguageSelect.value;
            
            if (!code) {
                showAlert('Please enter code to document', 'warning');
                return;
            }
            
            // Save current prompt for potential saving
            currentPromptType = 'documentation';
            currentPromptContent = code;
            
            showLoadingResponse();
            generateDocsModal.hide();
            
            fetch('/api/ai/generate-documentation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    code: code,
                    language: language
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showTextResponse(data.documentation, 'Generated Documentation:');
                    } else {
                        showErrorResponse(data.message || 'Failed to generate documentation');
                    }
                })
                .catch(error => {
                    console.error('Error generating documentation:', error);
                    showErrorResponse(error.message);
                });
        });
        
        // Copy response
        copyResponseBtn.addEventListener('click', function() {
            const content = aiResponse.textContent;
            navigator.clipboard.writeText(content)
                .then(() => {
                    showAlert('Response copied to clipboard!', 'success');
                })
                .catch(err => {
                    console.error('Failed to copy text: ', err);
                    showAlert('Failed to copy to clipboard', 'danger');
                });
        });
        
        // Clear response
        clearResponseBtn.addEventListener('click', function() {
            aiResponse.innerHTML = `
                <div class="text-center text-muted py-5">
                    <i data-feather="cpu" style="width: 48px; height: 48px;"></i>
                    <p class="mt-3">Use the tools on the left to generate AI responses</p>
                </div>
            `;
            feather.replace();
        });
        
        // Save prompt
        savePromptBtn.addEventListener('click', function() {
            if (!currentPromptType || !currentPromptContent) {
                showAlert('No prompt to save. Generate content first.', 'warning');
                return;
            }
            
            promptTypeSelect.value = currentPromptType;
            promptContentInput.value = currentPromptContent;
            savePromptModal.show();
        });
        
        savePromptSubmit.addEventListener('click', function() {
            const name = promptNameInput.value.trim();
            
            if (!name) {
                showAlert('Please enter a name for the prompt', 'warning');
                return;
            }
            
            if (!currentPromptType || !currentPromptContent) {
                showAlert('No prompt content to save', 'warning');
                return;
            }
            
            // Save to local storage
            const savedPrompts = JSON.parse(localStorage.getItem('ai_saved_prompts') || '[]');
            savedPrompts.push({
                id: Date.now().toString(),
                name: name,
                type: currentPromptType,
                content: currentPromptContent,
                created: new Date().toISOString()
            });
            
            localStorage.setItem('ai_saved_prompts', JSON.stringify(savedPrompts));
            savePromptModal.hide();
            
            showAlert(`Prompt "${name}" saved successfully!`, 'success');
            loadSavedPrompts();
        });
        
        // Show loading response
        function showLoadingResponse() {
            aiResponse.innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Generating response...</p>
                </div>
            `;
        }
        
        // Show code response
        function showCodeResponse(code, title = 'Response:') {
            aiResponse.innerHTML = `
                <h5>${title}</h5>
                <div class="code-block p-3 bg-dark text-light mb-3">
                    <pre><code>${escapeHtml(code)}</code></pre>
                </div>
            `;
        }
        
        // Show text response
        function showTextResponse(text, title = 'Response:') {
            aiResponse.innerHTML = `
                <h5>${title}</h5>
                <div class="ai-response">
                    ${formatTextWithMarkdown(text)}
                </div>
            `;
        }
        
        // Show improvements response
        function showImprovementsResponse(suggestions) {
            let html = `<h5>Code Improvement Suggestions:</h5>`;
            
            if (suggestions.summary) {
                html += `
                    <div class="alert alert-info">
                        <strong>Summary:</strong> ${escapeHtml(suggestions.summary)}
                    </div>
                `;
            }
            
            if (suggestions.suggestions && suggestions.suggestions.length > 0) {
                html += `<div class="list-group mb-3">`;
                
                suggestions.suggestions.forEach((suggestion, index) => {
                    html += `
                        <div class="list-group-item">
                            <h6 class="mb-1">${index + 1}. ${escapeHtml(suggestion.issue)}</h6>
                            <p class="mb-1">${escapeHtml(suggestion.improvement)}</p>
                            ${suggestion.code ? `
                                <div class="code-block p-2 bg-dark text-light mt-2">
                                    <pre><code>${escapeHtml(suggestion.code)}</code></pre>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                html += `</div>`;
            }
            
            aiResponse.innerHTML = html;
        }
        
        // Show debug response
        function showDebugResponse(debugResults) {
            let html = `<h5>Debugging Results:</h5>`;
            
            if (debugResults.identified_issues && debugResults.identified_issues.length > 0) {
                html += `
                    <div class="alert alert-warning mb-3">
                        <strong>Identified Issues:</strong>
                        <ul class="mb-0 mt-2">
                `;
                
                debugResults.identified_issues.forEach(issue => {
                    html += `<li>${escapeHtml(issue)}</li>`;
                });
                
                html += `
                        </ul>
                    </div>
                `;
            }
            
            if (debugResults.explanation) {
                html += `
                    <div class="mb-3">
                        <h6>Explanation:</h6>
                        <div class="ai-response">
                            ${formatTextWithMarkdown(debugResults.explanation)}
                        </div>
                    </div>
                `;
            }
            
            if (debugResults.fixes && debugResults.fixes.length > 0) {
                html += `
                    <div class="mb-3">
                        <h6>Fixes:</h6>
                        <div class="list-group">
                `;
                
                debugResults.fixes.forEach((fix, index) => {
                    html += `
                        <div class="list-group-item">
                            <h6 class="mb-1">Fix ${index + 1}:</h6>
                            ${fix.original ? `
                                <div class="mb-2">
                                    <strong>Original:</strong>
                                    <div class="code-block p-2 bg-dark text-light mt-1">
                                        <pre><code>${escapeHtml(fix.original)}</code></pre>
                                    </div>
                                </div>
                            ` : ''}
                            ${fix.fixed ? `
                                <div>
                                    <strong>Fixed:</strong>
                                    <div class="code-block p-2 bg-dark text-light mt-1">
                                        <pre><code>${escapeHtml(fix.fixed)}</code></pre>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            if (debugResults.fixed_code) {
                html += `
                    <div class="mb-3">
                        <h6>Complete Fixed Code:</h6>
                        <div class="code-block p-3 bg-dark text-light">
                            <pre><code>${escapeHtml(debugResults.fixed_code)}</code></pre>
                        </div>
                    </div>
                `;
            }
            
            aiResponse.innerHTML = html;
        }
        
        // Show error response
        function showErrorResponse(error) {
            aiResponse.innerHTML = `
                <div class="alert alert-danger">
                    <strong>Error:</strong> ${escapeHtml(error)}
                </div>
                <p class="text-muted">Please try again or modify your request.</p>
            `;
        }
        
        // Load saved prompts
        function loadSavedPrompts() {
            const savedPrompts = JSON.parse(localStorage.getItem('ai_saved_prompts') || '[]');
            
            if (savedPrompts.length === 0) {
                savedPromptsContainer.innerHTML = `
                    <div class="text-center text-muted">
                        <p>No saved prompts</p>
                    </div>
                `;
                return;
            }
            
            // Sort by creation date (newest first)
            savedPrompts.sort((a, b) => new Date(b.created) - new Date(a.created));
            
            let html = `<div class="list-group">`;
            
            savedPrompts.forEach(prompt => {
                const truncatedContent = prompt.content.length > 50 
                    ? prompt.content.substring(0, 50) + '...' 
                    : prompt.content;
                
                html += `
                    <div class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${escapeHtml(prompt.name)}</h6>
                            <small class="text-muted">${getPromptTypeLabel(prompt.type)}</small>
                        </div>
                        <p class="mb-1 text-truncate">${escapeHtml(truncatedContent)}</p>
                        <div class="d-flex justify-content-end mt-2">
                            <button class="btn btn-sm btn-outline-primary me-2 use-prompt-btn" data-id="${prompt.id}">
                                <i data-feather="play" class="me-1"></i>Use
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-prompt-btn" data-id="${prompt.id}">
                                <i data-feather="trash-2" class="me-1"></i>Delete
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            savedPromptsContainer.innerHTML = html;
            feather.replace();
            
            // Add event listeners
            document.querySelectorAll('.use-prompt-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const promptId = this.dataset.id;
                    usePrompt(promptId);
                });
            });
            
            document.querySelectorAll('.delete-prompt-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const promptId = this.dataset.id;
                    deletePrompt(promptId);
                });
            });
        }
        
        // Use a saved prompt
        function usePrompt(promptId) {
            const savedPrompts = JSON.parse(localStorage.getItem('ai_saved_prompts') || '[]');
            const prompt = savedPrompts.find(p => p.id === promptId);
            
            if (!prompt) return;
            
            // Set the prompt in the correct form
            switch (prompt.type) {
                case 'generation':
                    generationPromptInput.value = prompt.content;
                    generationLanguageSelect.focus();
                    break;
                case 'explanation':
                    explanationCodeInput.value = prompt.content;
                    break;
                case 'improvements':
                    improvementsCodeInput.value = prompt.content;
                    improvementsLanguageSelect.focus();
                    break;
                case 'tests':
                    testsCodeInput.value = prompt.content;
                    generateTestsModal.show();
                    break;
                case 'translation':
                    translateCodeInput.value = prompt.content;
                    translateCodeModal.show();
                    break;
                case 'debug':
                    debugCodeInput.value = prompt.content;
                    debugCodeModal.show();
                    break;
                case 'documentation':
                    docsCodeInput.value = prompt.content;
                    generateDocsModal.show();
                    break;
            }
        }
        
        // Delete a saved prompt
        function deletePrompt(promptId) {
            if (!confirm('Are you sure you want to delete this prompt?')) {
                return;
            }
            
            const savedPrompts = JSON.parse(localStorage.getItem('ai_saved_prompts') || '[]');
            const filteredPrompts = savedPrompts.filter(p => p.id !== promptId);
            
            localStorage.setItem('ai_saved_prompts', JSON.stringify(filteredPrompts));
            showAlert('Prompt deleted successfully!', 'success');
            loadSavedPrompts();
        }
        
        // Get human-readable prompt type label
        function getPromptTypeLabel(type) {
            const labels = {
                'generation': 'Generate',
                'explanation': 'Explain',
                'improvements': 'Improve',
                'tests': 'Tests',
                'translation': 'Translate',
                'debug': 'Debug',
                'documentation': 'Docs'
            };
            
            return labels[type] || type;
        }
        
        // Format text with markdown-like syntax
        function formatTextWithMarkdown(text) {
            if (!text) return '';
            
            // Replace code blocks
            text = text.replace(/```([a-z]*)\n([\s\S]*?)\n```/g, '<pre><code>$2</code></pre>');
            
            // Replace inline code
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Replace headers
            text = text.replace(/^### (.*$)/gm, '<h5>$1</h5>');
            text = text.replace(/^## (.*$)/gm, '<h4>$1</h4>');
            text = text.replace(/^# (.*$)/gm, '<h3>$1</h3>');
            
            // Replace bold and italic
            text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            
            // Replace lists
            text = text.replace(/^\s*\d+\.\s+(.*$)/gm, '<li>$1</li>');
            text = text.replace(/^\s*\*\s+(.*$)/gm, '<li>$1</li>');
            
            // Wrap lists in ul/ol tags
            text = text.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
            
            // Replace paragraphs
            text = text.replace(/\n\n/g, '</p><p>');
            
            // Wrap with paragraph tags if not already done
            if (!text.startsWith('<')) {
                text = `<p>${text}</p>`;
            }
            
            return text;
        }
        
        // Helper function to escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Initial load
        loadSavedPrompts();
    });
</script>
{% endblock %}
