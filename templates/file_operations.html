{% extends "layout.html" %}

{% block title %}Replit Agent - File Operations{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12 mb-4">
        <h2><i data-feather="file" class="me-2"></i>File Operations</h2>
        <p class="lead">Manage files and directories in your project.</p>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i data-feather="folder" class="me-2"></i>File Browser</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="current-path" class="form-label">Current Path</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="current-path" value=".">
                        <button class="btn btn-outline-secondary" type="button" id="navigate-btn">Go</button>
                    </div>
                </div>
                <div class="file-browser" id="file-list">
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <button class="btn btn-sm btn-outline-primary me-2" id="create-file-btn">
                    <i data-feather="file-plus" class="me-1"></i> New File
                </button>
                <button class="btn btn-sm btn-outline-primary" id="create-dir-btn">
                    <i data-feather="folder-plus" class="me-1"></i> New Directory
                </button>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i data-feather="edit" class="me-2"></i>File Editor</h5>
                <span id="current-file-path" class="text-muted d-none">No file selected</span>
            </div>
            <div class="card-body">
                <div id="editor-container" class="mb-3">
                    <textarea class="form-control" id="file-editor" rows="15" placeholder="Select a file to edit"></textarea>
                </div>
                <div class="d-flex justify-content-end">
                    <button class="btn btn-primary me-2 d-none" id="save-btn">
                        <i data-feather="save" class="me-1"></i> Save
                    </button>
                    <button class="btn btn-danger d-none" id="delete-btn">
                        <i data-feather="trash-2" class="me-1"></i> Delete
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i data-feather="upload" class="me-2"></i>File Operations</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="source-path" class="form-label">Source Path</label>
                            <input type="text" class="form-control" id="source-path">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="destination-path" class="form-label">Destination Path</label>
                            <input type="text" class="form-control" id="destination-path">
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-end">
                    <button class="btn btn-outline-primary me-2" id="copy-btn">
                        <i data-feather="copy" class="me-1"></i> Copy
                    </button>
                    <button class="btn btn-outline-primary" id="move-btn">
                        <i data-feather="move" class="me-1"></i> Move
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New File Modal -->
<div class="modal fade" id="new-file-modal" tabindex="-1" aria-labelledby="new-file-modal-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="new-file-modal-label">Create New File</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="new-file-name" class="form-label">File Name</label>
                    <input type="text" class="form-control" id="new-file-name">
                </div>
                <div class="mb-3">
                    <label for="new-file-content" class="form-label">Initial Content (optional)</label>
                    <textarea class="form-control" id="new-file-content" rows="5"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="create-file-submit">Create</button>
            </div>
        </div>
    </div>
</div>

<!-- New Directory Modal -->
<div class="modal fade" id="new-dir-modal" tabindex="-1" aria-labelledby="new-dir-modal-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="new-dir-modal-label">Create New Directory</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="new-dir-name" class="form-label">Directory Name</label>
                    <input type="text" class="form-control" id="new-dir-name">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="create-dir-submit">Create</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const currentPathInput = document.getElementById('current-path');
        const fileList = document.getElementById('file-list');
        const fileEditor = document.getElementById('file-editor');
        const currentFilePath = document.getElementById('current-file-path');
        const saveBtn = document.getElementById('save-btn');
        const deleteBtn = document.getElementById('delete-btn');
        
        // New file modal elements
        const newFileModal = new bootstrap.Modal(document.getElementById('new-file-modal'));
        const newFileNameInput = document.getElementById('new-file-name');
        const newFileContentInput = document.getElementById('new-file-content');
        const createFileSubmitBtn = document.getElementById('create-file-submit');
        
        // New directory modal elements
        const newDirModal = new bootstrap.Modal(document.getElementById('new-dir-modal'));
        const newDirNameInput = document.getElementById('new-dir-name');
        const createDirSubmitBtn = document.getElementById('create-dir-submit');
        
        // File operation elements
        const sourcePathInput = document.getElementById('source-path');
        const destinationPathInput = document.getElementById('destination-path');
        const copyBtn = document.getElementById('copy-btn');
        const moveBtn = document.getElementById('move-btn');
        
        let currentPath = '.';
        let selectedFilePath = null;
        
        // Load file list from current path
        function loadFileList() {
            fileList.innerHTML = `
                <div class="d-flex justify-content-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;
            
            fetch(`/api/file/list?path=${encodeURIComponent(currentPath)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        renderFileList(data.files);
                    } else {
                        showAlert(data.message || 'Failed to load file list', 'danger');
                        fileList.innerHTML = `<div class="alert alert-danger">Failed to load file list</div>`;
                    }
                })
                .catch(error => {
                    console.error('Error loading file list:', error);
                    fileList.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                });
        }
        
        // Render file list
        function renderFileList(files) {
            if (!files || files.length === 0) {
                fileList.innerHTML = '<div class="text-center text-muted">No files found</div>';
                return;
            }
            
            // Sort directories first, then files
            files.sort((a, b) => {
                if (a.type === b.type) {
                    return a.name.localeCompare(b.name);
                }
                return a.type === 'directory' ? -1 : 1;
            });
            
            // Add parent directory if not in root
            let fileListHTML = '';
            if (currentPath !== '.') {
                fileListHTML += `
                    <div class="file-item" data-path="${getParentPath(currentPath)}" data-type="directory">
                        <i data-feather="arrow-up-circle"></i> ..
                    </div>
                `;
            }
            
            // Add all files and directories
            files.forEach(file => {
                const icon = file.type === 'directory' ? 'folder' : 'file-text';
                fileListHTML += `
                    <div class="file-item" data-path="${file.path}" data-type="${file.type}">
                        <i data-feather="${icon}"></i> ${file.name}
                    </div>
                `;
            });
            
            fileList.innerHTML = fileListHTML;
            
            // Initialize feather icons
            feather.replace();
            
            // Add click event to file items
            document.querySelectorAll('.file-item').forEach(item => {
                item.addEventListener('click', function() {
                    const path = this.dataset.path;
                    const type = this.dataset.type;
                    
                    if (type === 'directory') {
                        currentPath = path;
                        currentPathInput.value = currentPath;
                        loadFileList();
                    } else {
                        selectedFilePath = path;
                        currentFilePath.textContent = path;
                        currentFilePath.classList.remove('d-none');
                        loadFileContent(path);
                        saveBtn.classList.remove('d-none');
                        deleteBtn.classList.remove('d-none');
                    }
                });
            });
        }
        
        // Get parent directory path
        function getParentPath(path) {
            const parts = path.split('/');
            parts.pop();
            return parts.join('/') || '.';
        }
        
        // Load file content
        function loadFileContent(path) {
            fetch(`/api/file/read?path=${encodeURIComponent(path)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        fileEditor.value = data.content;
                    } else {
                        showAlert(data.message || 'Failed to read file', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error reading file:', error);
                    showAlert(`Error: ${error.message}`, 'danger');
                });
        }
        
        // Save file content
        function saveFileContent() {
            if (!selectedFilePath) return;
            
            const content = fileEditor.value;
            
            fetch('/api/file/write', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    path: selectedFilePath,
                    content: content
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showAlert(`File ${selectedFilePath} saved successfully!`, 'success');
                    } else {
                        showAlert(data.message || 'Failed to save file', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error saving file:', error);
                    showAlert(`Error: ${error.message}`, 'danger');
                });
        }
        
        // Delete file or directory
        function deleteFile() {
            if (!selectedFilePath) return;
            
            if (!confirm(`Are you sure you want to delete ${selectedFilePath}?`)) {
                return;
            }
            
            fetch('/api/file/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    path: selectedFilePath
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showAlert(`${selectedFilePath} deleted successfully!`, 'success');
                        
                        // Clear editor and reset selection
                        fileEditor.value = '';
                        selectedFilePath = null;
                        currentFilePath.textContent = 'No file selected';
                        currentFilePath.classList.add('d-none');
                        saveBtn.classList.add('d-none');
                        deleteBtn.classList.add('d-none');
                        
                        // Reload file list
                        loadFileList();
                    } else {
                        showAlert(data.message || 'Failed to delete file', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error deleting file:', error);
                    showAlert(`Error: ${error.message}`, 'danger');
                });
        }
        
        // Create new file
        function createNewFile() {
            const fileName = newFileNameInput.value.trim();
            if (!fileName) {
                showAlert('Please enter a file name', 'warning');
                return;
            }
            
            const filePath = currentPath === '.' ? fileName : `${currentPath}/${fileName}`;
            const content = newFileContentInput.value;
            
            fetch('/api/file/write', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    path: filePath,
                    content: content
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showAlert(`File ${filePath} created successfully!`, 'success');
                        newFileModal.hide();
                        newFileNameInput.value = '';
                        newFileContentInput.value = '';
                        loadFileList();
                    } else {
                        showAlert(data.message || 'Failed to create file', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error creating file:', error);
                    showAlert(`Error: ${error.message}`, 'danger');
                });
        }
        
        // Create new directory
        function createNewDirectory() {
            const dirName = newDirNameInput.value.trim();
            if (!dirName) {
                showAlert('Please enter a directory name', 'warning');
                return;
            }
            
            const dirPath = currentPath === '.' ? dirName : `${currentPath}/${dirName}`;
            
            fetch('/api/file/create-directory', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    path: dirPath
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showAlert(`Directory ${dirPath} created successfully!`, 'success');
                        newDirModal.hide();
                        newDirNameInput.value = '';
                        loadFileList();
                    } else {
                        showAlert(data.message || 'Failed to create directory', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error creating directory:', error);
                    showAlert(`Error: ${error.message}`, 'danger');
                });
        }
        
        // Copy file or directory
        function copyFile() {
            const sourcePath = sourcePathInput.value.trim();
            const destinationPath = destinationPathInput.value.trim();
            
            if (!sourcePath || !destinationPath) {
                showAlert('Please enter both source and destination paths', 'warning');
                return;
            }
            
            fetch('/api/file/copy', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    source: sourcePath,
                    destination: destinationPath
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showAlert(`Copied ${sourcePath} to ${destinationPath} successfully!`, 'success');
                        sourcePathInput.value = '';
                        destinationPathInput.value = '';
                        loadFileList();
                    } else {
                        showAlert(data.message || 'Failed to copy file/directory', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error copying file/directory:', error);
                    showAlert(`Error: ${error.message}`, 'danger');
                });
        }
        
        // Move file or directory
        function moveFile() {
            const sourcePath = sourcePathInput.value.trim();
            const destinationPath = destinationPathInput.value.trim();
            
            if (!sourcePath || !destinationPath) {
                showAlert('Please enter both source and destination paths', 'warning');
                return;
            }
            
            fetch('/api/file/move', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    source: sourcePath,
                    destination: destinationPath
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showAlert(`Moved ${sourcePath} to ${destinationPath} successfully!`, 'success');
                        sourcePathInput.value = '';
                        destinationPathInput.value = '';
                        loadFileList();
                        
                        // If the moved file was selected, update the selected file path
                        if (selectedFilePath === sourcePath) {
                            selectedFilePath = destinationPath;
                            currentFilePath.textContent = destinationPath;
                        }
                    } else {
                        showAlert(data.message || 'Failed to move file/directory', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error moving file/directory:', error);
                    showAlert(`Error: ${error.message}`, 'danger');
                });
        }
        
        // Event listeners
        document.getElementById('navigate-btn').addEventListener('click', function() {
            currentPath = currentPathInput.value.trim() || '.';
            loadFileList();
        });
        
        currentPathInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                currentPath = currentPathInput.value.trim() || '.';
                loadFileList();
            }
        });
        
        saveBtn.addEventListener('click', saveFileContent);
        deleteBtn.addEventListener('click', deleteFile);
        
        document.getElementById('create-file-btn').addEventListener('click', function() {
            newFileModal.show();
        });
        
        document.getElementById('create-dir-btn').addEventListener('click', function() {
            newDirModal.show();
        });
        
        createFileSubmitBtn.addEventListener('click', createNewFile);
        createDirSubmitBtn.addEventListener('click', createNewDirectory);
        
        copyBtn.addEventListener('click', copyFile);
        moveBtn.addEventListener('click', moveFile);
        
        // Initial file list load
        loadFileList();
    });
</script>
{% endblock %}
