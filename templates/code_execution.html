{% extends "layout.html" %}

{% block title %}Replit Agent - Code Execution{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12 mb-4">
        <h2><i data-feather="code" class="me-2"></i>Code Execution</h2>
        <p class="lead">Execute code in multiple programming languages.</p>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i data-feather="terminal" class="me-2"></i>Code Editor</h5>
            <div>
                <select class="form-select" id="language-select">
                    <option value="python" selected>Python</option>
                    <option value="javascript">JavaScript</option>
                    <option value="bash">Bash</option>
                    <option value="ruby">Ruby</option>
                </select>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="mb-3">
            <textarea class="form-control" id="code-editor" rows="15" placeholder="Write your code here..."></textarea>
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="with-dependencies-switch">
                    <label class="form-check-label" for="with-dependencies-switch">Include dependencies (Python only)</label>
                </div>
            </div>
            <div class="col-md-6 dependencies-section" style="display: none;">
                <div class="input-group">
                    <input type="text" class="form-control" id="dependencies-input" placeholder="e.g., requests,numpy,pandas">
                    <span class="input-group-text">Comma-separated</span>
                </div>
            </div>
        </div>
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <button class="btn btn-outline-secondary me-2" id="clear-btn">
                    <i data-feather="trash-2" class="me-1"></i>Clear
                </button>
                <button class="btn btn-outline-primary me-2" id="save-snippet-btn">
                    <i data-feather="save" class="me-1"></i>Save Snippet
                </button>
                <button class="btn btn-outline-info" id="load-snippet-btn">
                    <i data-feather="folder" class="me-1"></i>Load Snippet
                </button>
            </div>
            <button class="btn btn-primary" id="execute-btn">
                <i data-feather="play" class="me-1"></i>Execute
            </button>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i data-feather="activity" class="me-2"></i>Execution Results</h5>
            <div>
                <button class="btn btn-sm btn-outline-secondary" id="copy-output-btn">
                    <i data-feather="copy" class="me-1"></i>Copy
                </button>
                <button class="btn btn-sm btn-outline-secondary ms-2" id="clear-output-btn">
                    <i data-feather="trash-2" class="me-1"></i>Clear
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="output-container" id="execution-output">
            <div class="text-muted text-center">Execute code to see results here</div>
        </div>
    </div>
    <div class="card-footer" id="execution-stats" style="display: none;">
        <div class="row">
            <div class="col-md-4">
                <small class="text-muted">Execution Time: <span id="execution-time">0</span> seconds</small>
            </div>
            <div class="col-md-4 text-center">
                <small class="text-muted">Return Code: <span id="return-code">0</span></small>
            </div>
            <div class="col-md-4 text-end">
                <small class="text-muted">Language: <span id="execution-language">python</span></small>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i data-feather="book" class="me-2"></i>Code Snippets</h5>
            </div>
            <div class="card-body">
                <div class="list-group" id="snippets-list">
                    <div class="text-muted text-center">No saved snippets</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i data-feather="info" class="me-2"></i>Language Info</h5>
            </div>
            <div class="card-body">
                <div id="language-info">
                    <h6>Python</h6>
                    <p>Python is a high-level, interpreted programming language known for its readability and versatility.</p>
                    <ul>
                        <li>Version: Python 3.x</li>
                        <li>Standard libraries are available</li>
                        <li>Code execution limited to 10 seconds</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Save Snippet Modal -->
<div class="modal fade" id="save-snippet-modal" tabindex="-1" aria-labelledby="save-snippet-modal-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="save-snippet-modal-label">Save Code Snippet</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="snippet-name" class="form-label">Snippet Name</label>
                    <input type="text" class="form-control" id="snippet-name" placeholder="Enter a name for your snippet">
                </div>
                <div class="mb-3">
                    <label for="snippet-description" class="form-label">Description (optional)</label>
                    <textarea class="form-control" id="snippet-description" rows="3" placeholder="Enter a brief description"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-snippet-submit">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Load Snippet Modal -->
<div class="modal fade" id="load-snippet-modal" tabindex="-1" aria-labelledby="load-snippet-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="load-snippet-modal-label">Load Code Snippet</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" class="form-control" id="snippet-search" placeholder="Search snippets...">
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Language</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="snippets-table-body">
                            <tr>
                                <td colspan="4" class="text-center">No snippets found</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const codeEditor = document.getElementById('code-editor');
        const languageSelect = document.getElementById('language-select');
        const executeBtn = document.getElementById('execute-btn');
        const clearBtn = document.getElementById('clear-btn');
        const executionOutput = document.getElementById('execution-output');
        const executionStats = document.getElementById('execution-stats');
        const executionTime = document.getElementById('execution-time');
        const returnCode = document.getElementById('return-code');
        const executionLanguage = document.getElementById('execution-language');
        const copyOutputBtn = document.getElementById('copy-output-btn');
        const clearOutputBtn = document.getElementById('clear-output-btn');
        const withDependenciesSwitch = document.getElementById('with-dependencies-switch');
        const dependenciesSection = document.querySelector('.dependencies-section');
        const dependenciesInput = document.getElementById('dependencies-input');
        
        // Snippets functionality
        const saveSnippetBtn = document.getElementById('save-snippet-btn');
        const loadSnippetBtn = document.getElementById('load-snippet-btn');
        const saveSnippetModal = new bootstrap.Modal(document.getElementById('save-snippet-modal'));
        const loadSnippetModal = new bootstrap.Modal(document.getElementById('load-snippet-modal'));
        const snippetName = document.getElementById('snippet-name');
        const snippetDescription = document.getElementById('snippet-description');
        const saveSnippetSubmit = document.getElementById('save-snippet-submit');
        const snippetsTableBody = document.getElementById('snippets-table-body');
        const snippetSearch = document.getElementById('snippet-search');
        
        // Language information
        const languageInfo = document.getElementById('language-info');

        // Sample code templates
        const codeTemplates = {
            python: '# Python code example\n\ndef hello(name):\n    return f"Hello, {name}!"\n\nprint(hello("World"))\n',
            javascript: '// JavaScript code example\n\nfunction hello(name) {\n    return `Hello, ${name}!`;\n}\n\nconsole.log(hello("World"));\n',
            bash: '#!/bin/bash\n# Bash code example\n\necho "Hello, World!"\n\n# List files in the current directory\nls -la\n',
            ruby: '# Ruby code example\n\ndef hello(name)\n    "Hello, #{name}!"\nend\n\nputs hello("World")\n'
        };
        
        // Language information
        const languageInfoTemplates = {
            python: `
                <h6>Python</h6>
                <p>Python is a high-level, interpreted programming language known for its readability and versatility.</p>
                <ul>
                    <li>Version: Python 3.x</li>
                    <li>Standard libraries are available</li>
                    <li>Code execution limited to 10 seconds</li>
                </ul>
            `,
            javascript: `
                <h6>JavaScript (Node.js)</h6>
                <p>Node.js is a JavaScript runtime built on Chrome's V8 JavaScript engine.</p>
                <ul>
                    <li>Version: Node.js</li>
                    <li>Standard libraries and built-in modules are available</li>
                    <li>Code execution limited to 10 seconds</li>
                </ul>
            `,
            bash: `
                <h6>Bash</h6>
                <p>Bash is a Unix shell and command language used as the default login shell for most Linux distributions.</p>
                <ul>
                    <li>Version: Bash</li>
                    <li>Basic Linux commands available</li>
                    <li>Code execution limited to 10 seconds</li>
                </ul>
            `,
            ruby: `
                <h6>Ruby</h6>
                <p>Ruby is a dynamic, object-oriented programming language designed for simplicity and productivity.</p>
                <ul>
                    <li>Version: Ruby</li>
                    <li>Standard libraries are available</li>
                    <li>Code execution limited to 10 seconds</li>
                </ul>
            `
        };
        
        // Initialize with the selected language's template
        codeEditor.value = codeTemplates[languageSelect.value];
        updateLanguageInfo();
        
        // Execute code
        executeBtn.addEventListener('click', function() {
            const code = codeEditor.value;
            const language = languageSelect.value;
            
            if (!code.trim()) {
                showAlert('Please enter some code to execute', 'warning');
                return;
            }
            
            // Change button state to loading
            executeBtn.disabled = true;
            executeBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Executing...';
            
            // Clear previous output
            executionOutput.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><div class="mt-2">Executing code...</div></div>';
            
            // Prepare request data
            let requestData = {
                code: code,
                language: language
            };
            
            // Add dependencies if selected (for Python only)
            if (language === 'python' && withDependenciesSwitch.checked) {
                const dependencies = dependenciesInput.value.trim().split(',').filter(dep => dep.trim());
                if (dependencies.length > 0) {
                    requestData.dependencies = dependencies;
                }
            }
            
            // Send execution request
            fetch('/api/code/execute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const result = data.result;
                        
                        // Update execution output
                        let outputHtml = '';
                        
                        if (result.stdout) {
                            outputHtml += `<div class="stdout">${escapeHtml(result.stdout)}</div>`;
                        }
                        
                        if (result.stderr) {
                            outputHtml += `<div class="stderr text-danger">${escapeHtml(result.stderr)}</div>`;
                        }
                        
                        if (!result.stdout && !result.stderr) {
                            outputHtml = '<div class="text-muted">No output</div>';
                        }
                        
                        executionOutput.innerHTML = outputHtml;
                        
                        // Update execution stats
                        executionTime.textContent = result.execution_time.toFixed(3);
                        returnCode.textContent = result.return_code;
                        executionLanguage.textContent = language;
                        executionStats.style.display = 'block';
                    } else {
                        executionOutput.innerHTML = `<div class="text-danger">${data.message || 'Execution failed'}</div>`;
                        executionStats.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error executing code:', error);
                    executionOutput.innerHTML = `<div class="text-danger">Error: ${error.message}</div>`;
                    executionStats.style.display = 'none';
                })
                .finally(() => {
                    // Reset button state
                    executeBtn.disabled = false;
                    executeBtn.innerHTML = '<i data-feather="play" class="me-1"></i>Execute';
                    feather.replace();
                });
        });
        
        // Clear editor
        clearBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to clear the editor?')) {
                codeEditor.value = '';
            }
        });
        
        // Copy output
        copyOutputBtn.addEventListener('click', function() {
            const output = executionOutput.textContent;
            copyToClipboard(output);
        });
        
        // Clear output
        clearOutputBtn.addEventListener('click', function() {
            executionOutput.innerHTML = '<div class="text-muted text-center">Execute code to see results here</div>';
            executionStats.style.display = 'none';
        });
        
        // Update language template when language changes
        languageSelect.addEventListener('change', function() {
            const language = this.value;
            
            // Only change code if editor is empty or has a template
            const currentCode = codeEditor.value.trim();
            const isTemplate = Object.values(codeTemplates).some(template => 
                currentCode === template.trim() || currentCode === '');
            
            if (isTemplate) {
                codeEditor.value = codeTemplates[language];
            }
            
            // Update language info
            updateLanguageInfo();
            
            // Show/hide dependencies section
            if (language === 'python') {
                withDependenciesSwitch.disabled = false;
                updateDependenciesSection();
            } else {
                withDependenciesSwitch.checked = false;
                withDependenciesSwitch.disabled = true;
                dependenciesSection.style.display = 'none';
            }
        });
        
        // Toggle dependencies section
        withDependenciesSwitch.addEventListener('change', updateDependenciesSection);
        
        function updateDependenciesSection() {
            dependenciesSection.style.display = withDependenciesSwitch.checked ? 'block' : 'none';
        }
        
        // Update language info
        function updateLanguageInfo() {
            const language = languageSelect.value;
            languageInfo.innerHTML = languageInfoTemplates[language];
        }
        
        // Save snippet button click
        saveSnippetBtn.addEventListener('click', function() {
            if (!codeEditor.value.trim()) {
                showAlert('Cannot save an empty snippet', 'warning');
                return;
            }
            
            // Clear previous values
            snippetName.value = '';
            snippetDescription.value = '';
            
            saveSnippetModal.show();
        });
        
        // Save snippet submit
        saveSnippetSubmit.addEventListener('click', function() {
            const name = snippetName.value.trim();
            if (!name) {
                showAlert('Please enter a name for your snippet', 'warning');
                return;
            }
            
            // Get snippets from local storage
            let snippets = JSON.parse(localStorage.getItem('code_snippets') || '[]');
            
            // Add new snippet
            snippets.push({
                id: Date.now().toString(),
                name: name,
                description: snippetDescription.value.trim(),
                code: codeEditor.value,
                language: languageSelect.value,
                created: new Date().toISOString()
            });
            
            // Save to local storage
            localStorage.setItem('code_snippets', JSON.stringify(snippets));
            
            saveSnippetModal.hide();
            showAlert(`Snippet "${name}" saved successfully!`, 'success');
            
            // Update snippets list
            loadSnippetsList();
        });
        
        // Load snippet button click
        loadSnippetBtn.addEventListener('click', function() {
            loadSnippetsList();
            loadSnippetModal.show();
        });
        
        // Load snippets list
        function loadSnippetsList() {
            const snippets = JSON.parse(localStorage.getItem('code_snippets') || '[]');
            
            if (snippets.length === 0) {
                snippetsTableBody.innerHTML = '<tr><td colspan="4" class="text-center">No snippets found</td></tr>';
                return;
            }
            
            // Sort snippets by creation date (newest first)
            snippets.sort((a, b) => new Date(b.created) - new Date(a.created));
            
            // Render snippets
            let html = '';
            snippets.forEach(snippet => {
                html += `
                    <tr data-id="${snippet.id}">
                        <td>${escapeHtml(snippet.name)}</td>
                        <td>${snippet.language}</td>
                        <td>${escapeHtml(snippet.description || '')}</td>
                        <td>
                            <button class="btn btn-sm btn-primary load-snippet-btn" data-id="${snippet.id}">
                                <i data-feather="edit-3" class="me-1"></i>Load
                            </button>
                            <button class="btn btn-sm btn-danger delete-snippet-btn" data-id="${snippet.id}">
                                <i data-feather="trash-2" class="me-1"></i>Delete
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            snippetsTableBody.innerHTML = html;
            feather.replace();
            
            // Add event listeners to buttons
            document.querySelectorAll('.load-snippet-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const snippetId = this.dataset.id;
                    loadSnippet(snippetId);
                });
            });
            
            document.querySelectorAll('.delete-snippet-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const snippetId = this.dataset.id;
                    deleteSnippet(snippetId);
                });
            });
        }
        
        // Load snippet
        function loadSnippet(snippetId) {
            const snippets = JSON.parse(localStorage.getItem('code_snippets') || '[]');
            const snippet = snippets.find(s => s.id === snippetId);
            
            if (snippet) {
                // Confirm if editor has content
                if (codeEditor.value.trim() && codeEditor.value !== snippet.code) {
                    if (!confirm('This will replace your current code. Are you sure?')) {
                        return;
                    }
                }
                
                codeEditor.value = snippet.code;
                languageSelect.value = snippet.language;
                updateLanguageInfo();
                
                // Update dependencies section if applicable
                if (snippet.language === 'python') {
                    withDependenciesSwitch.disabled = false;
                } else {
                    withDependenciesSwitch.checked = false;
                    withDependenciesSwitch.disabled = true;
                    dependenciesSection.style.display = 'none';
                }
                
                loadSnippetModal.hide();
                showAlert(`Snippet "${snippet.name}" loaded successfully!`, 'success');
            }
        }
        
        // Delete snippet
        function deleteSnippet(snippetId) {
            if (!confirm('Are you sure you want to delete this snippet?')) {
                return;
            }
            
            let snippets = JSON.parse(localStorage.getItem('code_snippets') || '[]');
            const index = snippets.findIndex(s => s.id === snippetId);
            
            if (index !== -1) {
                const deletedName = snippets[index].name;
                snippets.splice(index, 1);
                localStorage.setItem('code_snippets', JSON.stringify(snippets));
                
                loadSnippetsList();
                showAlert(`Snippet "${deletedName}" deleted successfully!`, 'success');
            }
        }
        
        // Search snippets
        snippetSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            const rows = snippetsTableBody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const name = row.cells[0]?.textContent.toLowerCase() || '';
                const language = row.cells[1]?.textContent.toLowerCase() || '';
                const description = row.cells[2]?.textContent.toLowerCase() || '';
                
                if (name.includes(searchTerm) || language.includes(searchTerm) || description.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
        
        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    });
</script>
{% endblock %}
